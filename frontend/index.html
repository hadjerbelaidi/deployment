<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDS CICIDS2017 - Deep Learning Analyzer</title>
    <style>
        /* CSS INT√âGR√â ET AM√âLIOR√â */
        :root {
            --primary: #0984e3;
            --dark: #2d3436;
            --danger: #d63031;
            --success: #00b894;
            --bg: #f4f7f6;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); 
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container { max-width: 900px; width: 100%; text-align: center; }

        .status-bar {
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            background: #dfe6e9;
            border-radius: 50%;
        }

        .status-indicator.online { 
            background: var(--success); 
            box-shadow: 0 0 8px var(--success); 
        }

        h1 { color: var(--dark); margin-bottom: 5px; }
        .subtitle { color: #636e72; margin-bottom: 30px; }

        /* Grille de Stats (Correction Undefined) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--dark);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: left;
            transition: transform 0.2s;
        }

        .stat-card h4 { margin: 0; font-size: 0.8em; color: #b2bec3; text-transform: uppercase; }
        .stat-card .value { font-size: 1.2em; font-weight: bold; margin-top: 8px; color: #fab1a0; }

        /* Cartes d'action */
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); 
            margin-bottom: 25px; 
        }

        input[type="file"] { margin: 20px 0; }

        button { 
            background-color: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            transition: 0.3s;
        }

        button:hover:not(:disabled) { background-color: #074b83; transform: translateY(-2px); }
        button:disabled { background-color: #b2bec3; cursor: not-allowed; }

        /* Tableau d'Historique */
        .history-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #dfe6e9; text-align: left; color: var(--dark); }
        td { padding: 12px; border-bottom: 1px solid #dfe6e9; text-align: left; }
        
        .badge-attack { color: var(--danger); font-weight: bold; }
        .badge-benign { color: var(--success); font-weight: bold; }

        .result-box {
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="status-bar">
            <span class="status-indicator" id="indicator"></span>
            <span id="status-text">Connexion au Cloud Render...</span>
        </div>

        <h1>üõ°Ô∏è CICIDS-2017 Deep Analyzer</h1>
        <p class="subtitle">Analyse du trafic r√©seau par Intelligence Artificielle (MLP)</p>

        <div class="stats-grid" id="stats-content">
            <div class="stat-card">
                <h4>Architecture</h4>
                <div class="value">MLP (4 Layers)</div>
            </div>
            <div class="stat-card">
                <h4>Pr√©cision</h4>
                <div class="value">99.36%</div>
            </div>
            <div class="stat-card">
                <h4>H√©bergement</h4>
                <div class="value">Render Cloud</div>
            </div>
        </div>

        <div class="card">
            <h3>üìÇ Analyser un fichier de trafic</h3>
            <p>S√©lectionnez un fichier CSV (format CICIDS2017)</p>
            <input type="file" id="csv-file" accept=".csv" onchange="handleFileSelect(event)">
            <p id="file-name-display" style="font-weight: bold; color: var(--primary);"></p>
            <button id="batch-btn" onclick="predictBatch()" disabled>üöÄ Lancer l'Analyse</button>
        </div>

        <div id="batch-result" class="card" style="display: none; border: 2px solid var(--primary);"></div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>üìú Historique des scans</h3>
                <button onclick="loadHistory()" style="padding: 5px 10px; font-size: 0.8em;">Actualiser</button>
            </div>
            <div class="history-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Fichier</th>
                            <th>Lignes</th>
                            <th>Attaques d√©tect√©es</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        // 1. Initialisation au chargement
        window.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadHistory();
        });

        // 2. V√©rification Sant√© Serveur
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                if (data.status === 'healthy') {
                    document.getElementById('status-text').textContent = '‚úÖ Serveur Cloud Op√©rationnel';
                    document.getElementById('indicator').classList.add('online');
                }
            } catch (error) {
                document.getElementById('status-text').textContent = '‚ùå Serveur hors ligne (R√©veil en cours...)';
            }
        }

        // 3. Gestion du fichier
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('file-name-display').textContent = `Fichier pr√™t : ${file.name}`;
                document.getElementById('batch-btn').disabled = false;
            }
        }

        // 4. Envoi pour Analyse et Sauvegarde en DB
        async function predictBatch() {
            const fileInput = document.getElementById('csv-file');
            const resultDiv = document.getElementById('batch-result');
            const btn = document.getElementById('batch-btn');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            btn.disabled = true;
            btn.textContent = "‚è≥ Analyse en cours...";
            resultDiv.style.display = "block";
            resultDiv.innerHTML = "Analyse des patterns de s√©curit√© sur Render...";

            try {
                const response = await fetch(`${API_BASE}/api/predict_batch`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                // Affichage du r√©sultat direct
                resultDiv.innerHTML = `
                    <h2 style="color: ${data.attacks > 0 ? 'var(--danger)' : 'var(--success)'}">
                        ${data.attacks > 0 ? 'üö® Intrusion D√©tect√©e !' : '‚úÖ Trafic Sain'}
                    </h2>
                    <p>Fichier : <b>${data.filename}</b></p>
                    <p>Total lignes : <b>${data.total}</b> | Attaques : <b style="color:red">${data.attacks}</b></p>
                `;

                loadHistory(); // Rafra√Æchir le tableau d'historique
            } catch (error) {
                resultDiv.innerHTML = "‚ùå Erreur lors de l'analyse.";
            } finally {
                btn.disabled = false;
                btn.textContent = "üöÄ Lancer l'Analyse";
            }
        }

        // 5. Charger l'historique depuis SQLite via l'API
        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/history`);
                const history = await response.json();
                const tbody = document.getElementById('history-body');
                
                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">Aucun historique disponible.</td></tr>';
                    return;
                }

                tbody.innerHTML = history.map(h => `
                    <tr>
                        <td>${h.date}</td>
                        <td>${h.filename}</td>
                        <td>${h.total}</td>
                        <td><span class="${h.attacks > 0 ? 'badge-attack' : 'badge-benign'}">${h.attacks}</span></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error("Erreur chargement historique");
            }
        }
    </script>
</body>
</html>
